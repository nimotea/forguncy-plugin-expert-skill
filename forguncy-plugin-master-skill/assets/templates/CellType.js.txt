/// <reference path="../Declarations/forguncy.d.ts" />
/// <reference path="../Declarations/forguncy.Plugin.d.ts" />

// 最佳实践：定义与 C# Enum 对应的 JS 常量对象，避免魔法数字
// const MyEnumType = {
//     OptionA: 0,
//     OptionB: 1
// };

class MyPluginCellType extends Forguncy.Plugin.CellTypeBase {
    /**
     * 创建单元格内容
     * 重要：严禁使用 async 关键字，必须同步返回 DOM 元素，否则会导致单元格显示为空白
     */
    createContent() {
        const cellType = this.CellElement.CellType;
        console.log("[MyPlugin]: createContent started.", cellType);

        const container = $("<div></div>");
        container.text(cellType.MyOption || "Hello Forguncy");
        
        // 示例：使用 Enum 对象进行分支判断
        // if (cellType.Type === MyEnumType.OptionA) { ... }

        // 示例：使用 applySettings 批量同步配置
        // const options = {
        //     title: "Default Title",
        //     color: "#000000"
        // };
        // this.applySettings(options, cellType, {
        //     "title": "HeaderTitle",  // JS属性: C#属性
        //     "color": "ForeColor"
        // });

        console.log("[MyPlugin]: createContent complete.");
        return container;
    }

    onRender(container, renderInfo) {
        // 当单元格值发生变化时，活字格会调用此方法重新渲染
        console.log("[MyPlugin]: onRender triggered.", renderInfo);
        
        // super.onRender(container, renderInfo); // 如果不需要默认行为，可以不调用 super
    }

    onPageLoaded() {
        // 页面加载完成后调用
        // 建议在此处初始化依赖 DOM 的第三方库或绑定全局事件
    }

    /**
     * 辅助函数：等待容器获得真实尺寸后再执行回调
     * 活字格的 DOM 挂载是异步的，直接在 createContent 中获取尺寸可能为 0
     */
    waitForSize(container, callback) {
        const checkSize = () => {
            const width = container.width();
            const height = container.height();
            if (width > 0 && height > 0) {
                callback(width, height);
            } else {
                requestAnimationFrame(checkSize);
            }
        };
        checkSize();
    }

    /**
     * 辅助函数：批量应用配置到目标对象
     * 用于解决 C# 属性与 JS 库配置项命名不一致的问题，减少手动 if/else 赋值
     * @param {Object} target - 目标配置对象 (如第三方库的 options)
     * @param {Object} source - 源配置对象 (通常是 this.CellElement.CellType)
     * @param {Object} mapping - 属性映射表 { "JS配置项名": "CSharp属性名" }
     */
    applySettings(target, source, mapping) {
        for (const [jsKey, csKey] of Object.entries(mapping)) {
            const value = source[csKey];
            // 只有当 C# 属性值不为 null/undefined 时才覆盖
            if (value !== undefined && value !== null) {
                target[jsKey] = value;
            }
        }
    }

    destroy() {
        // 单元格销毁时调用
        // 重要：凡是涉及到 window/document 的事件绑定或定时器，必须在此处手动解绑/清除
        // 示例：window.removeEventListener('resize', this._resizeHandler);
        super.destroy();
    }
}

// 注册单元格插件
// 参数格式: "命名空间.类名, 程序集名称"
Forguncy.Plugin.CellTypeHelper.registerCellType("MyPluginNamespace.MyCellType, MyPluginNamespace", MyPluginCellType);
